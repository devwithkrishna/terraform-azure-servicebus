name: update-readme

on:
  workflow_dispatch:
  push:
    branches:
    - main
    paths:
    - 'README.md'
    - 'test/README.md'

permissions:
  contents: write

jobs:
  update-tree:
    runs-on: ubuntu-latest

    steps:
    - name: Token generator
      uses: githubofkrishnadhas/github-access-using-githubapp@v2
      id: token-generation
      with:
        github_app_id: ${{ secrets.TOKEN_GENERATOR_APPID }}
        github_app_private_key: ${{ secrets.TOKEN_GENERATOR_PRIVATE_KEY }}

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install tree utility
      run: |
        sudo apt-get update
        sudo apt-get install -y tree

    - name: Generate and inject folder tree
      run: |
        set -e
        tree_output=$(tree -I ".git|.github|__pycache__|*.pyc" -a)
        escaped_tree=$(printf '%s\n' "$tree_output")

        awk -v new_content="$escaped_tree" '
          /<!-- BEGIN_REPO_TREE -->/ { print; print "```"; print new_content; print "```"; in_block=1; next }
          /<!-- END_REPO_TREE -->/ { in_block=0 }
          !in_block
        ' README.md > README.tmp && mv README.tmp README.md

    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git status
        git add README.md
        git commit -m "docs: update README with repo structure" || echo "No changes to commit"
        git fetch origin
        git pull --rebase origin main || true
        git push origin main

  update-terraform-docs:
    runs-on: ubuntu-latest
    needs: update-tree

    steps:
    - name: Token generator
      uses: githubofkrishnadhas/github-access-using-githubapp@v2
      id: token-generation
      with:
        github_app_id: ${{ secrets.TOKEN_GENERATOR_APPID }}
        github_app_private_key: ${{ secrets.TOKEN_GENERATOR_PRIVATE_KEY }}

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Render terraform docs inside the README.md and push changes back to PR branch
      uses: terraform-docs/gh-actions@v1.4.1
      with:
        working-dir: .
        output-file: README.md
        output-method: inject
        git-push: "true"
